<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${course.ten_khoa_hoc} + ' - Video Learning'">
      H·ªçc t·∫≠p Video
    </title>
    <!-- Font Awesome for icons -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      /* Reset CSS */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        color: #333;
        line-height: 1.6;
        background-color: white !important;
        overflow: hidden;
      }

      /* Header Navigation */
      .header-nav {
        background: linear-gradient(135deg, #002855 0%, #001f42 100%);
        color: white;
        padding: 1rem 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
      }

      .nav-container {
        padding: 0 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-left {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .back-btn {
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: background-color 0.3s ease;
      }

      .back-btn:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .course-title {
        font-size: 1.1rem;
        font-weight: 600;
      }

      .nav-right {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .progress-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
      }

      /* Course Progress Bar */
      .course-progress-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: 1rem;
      }

      .course-progress-bar {
        width: 100px;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
      }

      .course-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #45a049);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .course-progress-text {
        color: white;
        font-size: 0.8rem;
        font-weight: 600;
        min-width: 35px;
      }

      /* Main Layout - Full Screen */
      .main-container {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 0;
        height: 100vh;
        background: #000;
      }

      .main-container.ai-expanded {
        grid-template-columns: 300px 1fr 500px;
      }

      /* Video Player Area */
      .video-section {
        background: #000;
        position: relative;
        display: flex;
        flex-direction: column;
        height: 100vh;
        padding-top: 80px; /* Account for fixed header */
      }

      .video-player {
        flex: 1;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      .video-container {
        width: 100%;
        height: 100%;
        position: relative;
      }

      .custom-video-player {
        width: 100%;
        height: 100%;
        background: #000;
        position: relative;
      }

      #youtubePlayer {
        width: 100%;
        height: 100%;
      }

      .video-element {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      /* Custom Video Controls */
      .video-controls-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        padding: 2rem;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .video-container:hover .video-controls-overlay {
        opacity: 1;
      }

      .progress-bar-container {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 1rem;
        position: relative;
      }

      .progress-bar {
        height: 100%;
        background: #ff6b00;
        /* border-radius: 4px; */
        width: 0%;
        transition: width 0.1s ease;
      }

      .progress-handle {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        background: #ff6b00;
        border-radius: 50%;
        cursor: pointer;
        display: block;
        left: 0%;
        transition: left 0.1s ease;
        z-index: 10;
      }

      .progress-bar-container:hover .progress-handle {
        display: block;
      }

      .control-buttons {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .control-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        transition: background-color 0.3s ease;
      }

      .control-btn:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .time-display {
        color: white;
        font-size: 0.9rem;
        margin-left: auto;
      }

      .volume-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .volume-slider {
        width: 80px;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        cursor: pointer;
      }

      .volume-fill {
        height: 100%;
        background: white;
        border-radius: 2px;
        width: 100%;
      }

      .video-info {
        padding: 1.5rem 2rem;
        background: white;
        border-top: 1px solid #333;
      }

      .video-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: black;
        margin-bottom: 1rem;
      }

      .video-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }

      .control-left,
      .control-center,
      .control-right {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .completed-btn {
        background: #4caf50 !important;
        color: white !important;
        border-color: #4caf50 !important;
        transition: all 0.3s ease;
      }

      .completed-btn:hover {
        background: #45a049 !important;
        border-color: #45a049 !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
      }

      .completed-btn:disabled {
        background: #ccc !important;
        border-color: #ccc !important;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .completion-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #4caf50;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .completion-status i {
        color: #ffd700;
      }

      .quiz-redirect-btn:hover {
        background: #e55a00 !important;
        border-color: #e55a00 !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 107, 0, 0.3);
      }

      .quiz-retake-btn:hover {
        background: #218838 !important;
        border-color: #218838 !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }

      .watch-progress-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #666;
        font-size: 0.9rem;
        font-style: italic;
      }

      /* Notification Styles */
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 8px;
        padding: 1rem 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        z-index: 10000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        max-width: 300px;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        border-left: 4px solid #4caf50;
        color: #4caf50;
      }

      .notification.error {
        border-left: 4px solid #f44336;
        color: #f44336;
      }

      .notification.info {
        border-left: 4px solid #2196f3;
        color: #2196f3;
      }

      .notification i {
        font-size: 1.2rem;
      }

      /* Quiz Modal Styles */
      .quiz-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .quiz-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .quiz-modal-content {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 500px;
        width: 90%;
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-50px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .quiz-modal-header {
        margin-bottom: 1.5rem;
      }

      .quiz-modal-header i {
        font-size: 3rem;
        color: #ff6b00;
        margin-bottom: 1rem;
      }

      .quiz-modal-header h3 {
        color: #002855;
        margin: 0;
        font-size: 1.5rem;
      }

      .quiz-modal-body {
        margin-bottom: 2rem;
        color: #666;
        line-height: 1.6;
      }

      .quiz-modal-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
      }

      .quiz-modal-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        min-width: 120px;
      }

      .quiz-modal-btn.primary {
        background: #ff6b00;
        color: white;
      }

      .quiz-modal-btn.primary:hover {
        background: #e55a00;
        transform: translateY(-2px);
      }

      .quiz-modal-btn.secondary {
        background: #f8f9fa;
        color: #666;
        border: 1px solid #ddd;
      }

      .quiz-modal-btn.secondary:hover {
        background: #e9ecef;
        transform: translateY(-2px);
      }

      .control-btn-nav {
        padding: 0.5rem 1rem;
        border: 2px solid #002855;
        background: transparent;
        color: #002855;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        text-decoration: none;
      }

      .control-btn-nav:hover {
        background: #002855;
        color: white;
      }

      .control-btn-nav.quiz-btn {
        border-color: #ff6b00;
        color: #ff6b00;
      }

      .control-btn-nav.quiz-btn:hover {
        background: #ff6b00;
        color: white;
      }

      .control-btn-nav:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Course Content Sidebar */
      .course-content {
        background: white;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100vh;
        padding-top: 70px; /* Account for fixed header */
      }

      .content-header {
        background: linear-gradient(135deg, #002855 0%, #001f42 100%);
        color: white;
        padding: 2em;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .content-header h3 {
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .content-body {
        flex: 1;
        overflow-y: auto;
        /* padding: 1rem 0; */
      }

      .lesson-list {
        list-style: none;
      }

      .lesson-item {
        padding: 0.75rem 1.5rem;
        border-bottom: 1px solid #333;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .lesson-item:hover {
        background-color: rgba(123, 122, 122, 0.2);
      }

      .lesson-item.active {
        background-color: rgba(123, 122, 122, 0.2);
        border-left: 4px solid #002855;
      }

      .lesson-item a {
        text-decoration: none;
        color: #ccc;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .lesson-item .lesson-title {
        color: black;
        font-weight: 500;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .lesson-item .lesson-status {
        color: #002855;
        font-size: 0.9rem;
      }

      /* ƒê·ªãnh d·∫°ng n√∫t Quiz trong danh s√°ch b√†i h·ªçc */
      .quiz-link-container {
        margin-top: 15px;
      }
      .quiz-link {
        display: flex;
        align-items: center;
        padding: 12px;
        color: #ffd700; /* M√†u v√†ng cho ch·ªØ */
        font-size: 1.1em;
        font-weight: 500;
        background-color: #34495e; /* N·ªÅn ƒë·ªìng b·ªô v·ªõi b√†i h·ªçc */
        text-decoration: none;
      }
      .quiz-link:hover {
        background-color: #3e5c76; /* Hi·ªáu ·ª©ng hover ƒë·ªìng b·ªô */
      }
      .quiz-link.disabled {
        pointer-events: none;
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* AI Chat section */
      .ai-chat-section {
        background: #1a1a1a;
        border-left: 1px solid #333;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100vh;
        padding-top: 80px; /* Account for fixed header */
        width: 500px;
      }

      .ai-chat-header {
        background: linear-gradient(135deg, #ff6b00 0%, #e65c00 100%);
        color: white;
        padding: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .ai-chat-header h3 {
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .collapse-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.5rem;
      }

      .ai-chat-body {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-height: 80vh;
      }

      .chat-message {
        display: flex;
        gap: 1rem;
        max-width: 80%;
      }

      .chat-message.user {
        align-self: flex-end;
      }

      .chat-avatar {
        width: 36px;
        height: 36px;
        background: #f2f2f2;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 1rem;
      }

      .chat-avatar.ai {
        background: linear-gradient(135deg, #ff6b00 0%, #e65c00 100%);
        color: white;
      }

      .chat-avatar.user {
        background: linear-gradient(135deg, #002855 0%, #001f42 100%);
        color: white;
      }

      .chat-bubble {
        background: #2a2a2a;
        color: #ccc;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        max-width: 90%;
        word-break: break-word;
        white-space: pre-line;
      }

      .chat-message.user .chat-bubble {
        background: #333;
      }

      .chat-input-container {
        padding: 1rem;
        border-top: 1px solid #333;
      }

      .chat-input-form {
        display: flex;
        gap: 0.5rem;
      }

      .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid #333;
        background: #2a2a2a;
        color: #ccc;
        border-radius: 8px;
        resize: none;
        font-family: inherit;
        transition: border-color 0.3s ease;
      }

      .chat-input:focus {
        outline: none;
        border-color: #ff6b00;
      }

      .send-btn {
        background: linear-gradient(135deg, #ff6b00 0%, #e65c00 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
      }

      .send-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
      }

      /* Toggle AI Chat Button */
      .toggle-ai-chat {
        position: absolute;
        right: -18px;
        top: 50%;
        transform: translateY(-50%);
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #ff6b00 0%, #e65c00 100%);
        color: white;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      /* Loading Spinner */
      .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid #ff6b00;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: translate(-50%, -50%) rotate(0deg);
        }
        100% {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }

      /* Media Queries */
      @media (max-width: 768px) {
        .main-container,
        .main-container.ai-expanded {
          grid-template-columns: 1fr;
          height: auto;
          min-height: 100vh;
        }

        .course-content {
          order: 2;
          border-right: none;
          border-top: 1px solid #333;
          height: 300px;
        }

        .video-section {
          order: 1;
          height: 400px;
        }

        .ai-chat-section {
          order: 3;
          border-left: none;
          border-top: 1px solid #333;
          height: 300px;
        }

        .toggle-ai-chat {
          display: none;
        }

        .ai-chat-body {
          max-height: 200px;
        }

        .quiz-link {
          margin: 0.5rem 1rem;
        }
      }
      .watched-icon {
        color: #4caf50;
        margin-left: 5px;
        font-size: 0.9rem;
      }

      .lesson-status {
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }

      /* Locked video styles */
      .lesson-item.locked {
        opacity: 0.6;
        background-color: #f5f5f5;
      }

      .lesson-item.locked:hover {
        background-color: #f0f0f0;
      }

      .lesson-item.completed {
        background-color: #f8fff8;
      }

      .lesson-item.completed:hover {
        background-color: #f0fff0;
      }

      .locked-link {
        cursor: not-allowed !important;
        pointer-events: none;
      }

      .locked-icon {
        color: #ccc !important;
        font-size: 0.9rem;
      }
      .quiz-link.disabled {
        pointer-events: none;
        opacity: 0.5;
      }
    </style>
  </head>

  <body>
    <!-- Header Navigation -->
    <header class="header-nav">
      <div class="nav-container">
        <div class="nav-left">
          <a th:href="@{/index}" class="back-btn">
            <i class="fas fa-chevron-left"></i>
            <span>Quay l·∫°i</span>
          </a>
          <div class="course-title" th:text="${course.ten_khoa_hoc}">
            Android App Development v·ªõi Kotlin
          </div>
        </div>
        <div class="nav-right">
          <div class="progress-info">
            <span
              th:if="${videos != null && !videos.isEmpty()}"
              th:text="${'Video ' + (videos.indexOf(currentVideo) + 1) + '/' + videos.size()}"
              >Video 1/8</span
            >
            <!-- Course Progress Bar -->
            <div
              class="course-progress-container"
              th:if="${progressInfo != null}"
            >
              <div class="course-progress-bar">
                <div
                  class="course-progress-fill"
                  th:style="'width: ' + ${progressInfo.progress()} + '%'"
                ></div>
              </div>
              <span
                class="course-progress-text"
                th:text="${T(java.lang.Math).round(progressInfo.progress())} + '%'"
                >0%</span
              >
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Container -->
    <div
      id="mainContainer"
      class="main-container"
      th:classappend="${isAIChatExpanded ? 'ai-expanded' : ''}"
    >
      <!-- Course Content Sidebar -->
      <aside class="course-content">
        <div class="content-header">
          <h3>
            <i class="fas fa-book-open"></i>
            <span>Danh s√°ch b√†i h·ªçc</span>
          </h3>
        </div>
        <div class="content-body">
          <ul class="lesson-list">
            <li
              th:each="video : ${videos}"
              class="lesson-item"
              th:classappend="${(video.ID_video == currentVideo.ID_video ? 'active' : '') + (progressInfo != null && videos.indexOf(video) > progressInfo.completedVideos() ? ' locked' : '')}"
            >
              <a
                th:href="${progressInfo != null && videos.indexOf(video) <= progressInfo.completedVideos() ? '/video-learning/' + course.ID_khoa_hoc + '/' + video.ID_video : 'javascript:void(0)'}"
                th:class="${progressInfo != null && videos.indexOf(video) > progressInfo.completedVideos() ? 'locked-link' : ''}"
                th:attr="data-is-locked=${progressInfo != null && videos.indexOf(video) > progressInfo.completedVideos()}"
                onclick="handleVideoClick(this)"
              >
                <span class="lesson-title" th:text="${video.ten_video}"
                  >B√†i h·ªçc</span
                >
                <span class="lesson-status">
                  <!-- Current video indicator -->
                  <i
                    th:if="${video.ID_video == currentVideo.ID_video}"
                    class="fas fa-play-circle"
                    style="color: #002855"
                  ></i>
                  <!-- Completed video indicator -->
                  <i
                    th:if="${progressInfo != null && progressInfo.completedVideos() > 0 && videos.indexOf(video) < progressInfo.completedVideos()}"
                    class="fas fa-check-circle watched-icon"
                    style="color: #4caf50"
                  ></i>
                  <!-- Locked video indicator -->
                  <i
                    th:if="${progressInfo != null && videos.indexOf(video) > progressInfo.completedVideos()}"
                    class="fas fa-lock locked-icon"
                    style="color: #ccc"
                  ></i>
                </span>
              </a>
            </li>
          </ul>
          <!-- Th√™m n√∫t L√†m Quiz -->
          <div class="quiz-link-container">
            <a
              th:href="@{'/video-learning/quiz/' + ${course.ID_khoa_hoc}}"
              th:class="${allVideosWatched} ? 'quiz-link' : 'quiz-link disabled'"
              th:attr="data-all-videos-watched=${allVideosWatched}"
              onclick="handleQuizClick(this)"
              th:text="'L√†m b√†i ki·ªÉm tra: ' + ${course.ten_khoa_hoc}"
            >
              L√†m b√†i ki·ªÉm tra
            </a>
          </div>
        </div>
      </aside>

      <!-- Video Section -->
      <main class="video-section">
        <!-- Th√¥ng b√°o l·ªói n·∫øu kh√¥ng c√≥ video -->
        <div
          th:if="${errorMessage != null}"
          class="alert alert-warning text-center"
          style="margin: 2rem; font-size: 1.2rem"
        >
          <i class="fas fa-exclamation-triangle"></i>
          <span th:text="${errorMessage}"></span>
        </div>
        <div class="video-player">
          <div
            class="video-container"
            th:if="${currentVideo != null}"
            th:attr="data-video-url=${currentVideo.duong_dan_video}"
          >
            <div class="custom-video-player">
              <div id="youtubePlayer"></div>
              <div id="loadingSpinner" class="loading-spinner"></div>
              <div class="video-controls-overlay">
                <div class="progress-bar-container" id="progressContainer">
                  <div class="progress-bar" id="progressBar"></div>
                  <div class="progress-handle" id="progressHandle"></div>
                </div>
                <div class="control-buttons">
                  <button class="control-btn" id="playPauseBtn">
                    <i class="fas fa-play"></i>
                  </button>
                  <button class="control-btn" id="rewindBtn">
                    <i class="fas fa-backward"></i>
                  </button>
                  <button class="control-btn" id="forwardBtn" disabled>
                    <i class="fas fa-forward"></i>
                  </button>
                  <div class="volume-control">
                    <button class="control-btn" id="muteBtn">
                      <i class="fas fa-volume-up"></i>
                    </button>
                    <div class="volume-slider" id="volumeSlider">
                      <div class="volume-fill" id="volumeFill"></div>
                    </div>
                  </div>
                  <div class="time-display">
                    <span id="currentTime">0:00</span> /
                    <span id="duration">0:00</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="video-info">
          <h2
            class="video-title"
            th:text="${currentVideo != null ? currentVideo.ten_video : 'Kh√¥ng c√≥ video'}"
          >
            B√†i h·ªçc kh√¥ng c√≥ s·∫µn
          </h2>
          <div class="video-controls">
            <div class="control-left">
              <a
                th:if="${videos != null && !videos.isEmpty() && videos.indexOf(currentVideo) > 0}"
                th:href="@{'/video-learning/' + ${course.ID_khoa_hoc} + '/' + ${videos[videos.indexOf(currentVideo) - 1].ID_video}}"
                class="control-btn-nav"
              >
                <i class="fas fa-chevron-left"></i>
                <span>B√†i tr∆∞·ªõc</span>
              </a>
            </div>
            <div class="control-center">
              <button
                id="markCompletedBtn"
                class="control-btn-nav completed-btn"
                th:attr="data-course-id=${course.ID_khoa_hoc}, data-video-id=${currentVideo.ID_video}"
                th:if="${currentVideo != null && !hasCompletedCourse && progressInfo != null && videos.indexOf(currentVideo) == progressInfo.completedVideos()}"
                style="display: none"
              >
                <i class="fas fa-check-circle"></i>
                <span>ƒê√£ ho√†n th√†nh</span>
              </button>
              <div
                class="watch-progress-info"
                th:if="${currentVideo != null && !hasCompletedCourse && progressInfo != null && videos.indexOf(currentVideo) == progressInfo.completedVideos()}"
              >
                <span id="watchProgressText"
                  >Xem th√™m <span id="remainingPercent">0</span>% ƒë·ªÉ c√≥ th·ªÉ ƒë√°nh
                  d·∫•u ho√†n th√†nh</span
                >
              </div>
              <div
                class="completion-status"
                th:if="${progressInfo != null and progressInfo.progress() >= 100 and !progressInfo.isCompleted()}"
              >
                <i class="fas fa-trophy"></i>
                <span>ƒê√£ ho√†n th√†nh kh√≥a h·ªçc!</span>
                <a
                  th:href="@{'/video-learning/quiz/' + ${course.ID_khoa_hoc}}"
                  class="control-btn-nav quiz-redirect-btn"
                  style="
                    margin-left: 1rem;
                    background: #ff6b00;
                    color: white;
                    border-color: #ff6b00;
                  "
                >
                  <i class="fas fa-question-circle"></i>
                  <span>L√†m b√†i ki·ªÉm tra</span>
                </a>
                <a
                  th:href="@{'/video-learning/quiz/' + ${course.ID_khoa_hoc} + '?retake=true'}"
                  class="control-btn-nav quiz-retake-btn"
                  style="
                    margin-left: 0.5rem;
                    background: #28a745;
                    color: white;
                    border-color: #28a745;
                  "
                >
                  <i class="fas fa-redo"></i>
                  <span>L√†m l·∫°i b√†i ki·ªÉm tra</span>
                </a>
              </div>
            </div>
            <div class="control-right">
              <a
                th:if="${videos != null && !videos.isEmpty() && videos.indexOf(currentVideo) < videos.size() - 1 && progressInfo != null && videos.indexOf(currentVideo) < progressInfo.completedVideos()}"
                th:href="@{'/video-learning/' + ${course.ID_khoa_hoc} + '/' + ${videos[videos.indexOf(currentVideo) + 1].ID_video}}"
                class="control-btn-nav"
              >
                <span>B√†i ti·∫øp theo</span>
                <i class="fas fa-chevron-right"></i>
              </a>
              <button
                th:if="${videos != null && !videos.isEmpty() && videos.indexOf(currentVideo) < videos.size() - 1 && progressInfo != null && videos.indexOf(currentVideo) >= progressInfo.completedVideos()}"
                class="control-btn-nav"
                style="opacity: 0.5; cursor: not-allowed"
                disabled
              >
                <span>B√†i ti·∫øp theo</span>
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>

        <button id="toggleAiChat" class="toggle-ai-chat">
          <i id="toggleIcon" class="fas fa-comment-alt"></i>
        </button>
      </main>

      <div
        id="aiChatSection"
        class="ai-chat-section"
        th:style="${isAIChatExpanded ? '' : 'display: none;'}"
      >
        <div class="ai-chat-header">
          <h3>
            <i class="fas fa-robot"></i>
            <span>H·ªèi AI tr·ª£ gi·∫£ng</span>
          </h3>
          <button id="collapseAiChat" class="collapse-btn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="ai-chat-body" id="aiChatBody">
          <div class="chat-message">
            <div class="chat-avatar ai">
              <i class="fas fa-robot"></i>
            </div>
            <div class="chat-bubble">
              Xin ch√†o! T√¥i l√† AI tr·ª£ gi·∫£ng. B·∫°n c√≥ c√¢u h·ªèi g√¨ v·ªÅ b√†i h·ªçc n√†y
              kh√¥ng?
            </div>
          </div>
        </div>
        <div class="chat-input-container">
          <form
            class="chat-input-form"
            id="aiChatForm"
            onsubmit="return false;"
          >
            <textarea
              class="chat-input"
              id="aiChatInput"
              placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..."
              rows="2"
            ></textarea>
            <button type="submit" class="send-btn" id="aiChatSendBtn">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      // YouTube IFrame API
      let tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      let firstScriptTag = document.getElementsByTagName("script")[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // Video Player Variables
      let player;
      let playPauseBtn = document.getElementById("playPauseBtn");
      let rewindBtn = document.getElementById("rewindBtn");
      let forwardBtn = document.getElementById("forwardBtn");
      let muteBtn = document.getElementById("muteBtn");
      let progressBar = document.getElementById("progressBar");
      let progressContainer = document.getElementById("progressContainer");
      let progressHandle = document.getElementById("progressHandle");
      let volumeSlider = document.getElementById("volumeSlider");
      let volumeFill = document.getElementById("volumeFill");
      let currentTimeDisplay = document.getElementById("currentTime");
      let durationDisplay = document.getElementById("duration");
      let loadingSpinner = document.getElementById("loadingSpinner");

      // Video Progress Tracking
      let watchedSegments = [];
      let maxWatchedTime = 0;
      let currentVideoId = "";
      let progressInterval;
      let videoWatchProgress = 0; // Track video watch progress (0-100%)
      const REQUIRED_WATCH_PERCENTAGE = 80; // 80% required to mark as completed
      let hasAutoMarked = false; // Track if video has been auto-marked as completed

      const currentVideoIndex = /*[[${videos.indexOf(currentVideo)}]]*/ 0;
      const totalVideos = /*[[${videos.size()}]]*/ 0;
      const courseId = /*[[${course.ID_khoa_hoc}]]*/ 0;

      // L∆∞u tr·ªØ video IDs ƒë·ªÉ s·ª≠ d·ª•ng trong JavaScript
      const videoIds = /*[[${videos.![ID_video]}]]*/ [];

      // Get YouTube Video ID from URL
      function getYouTubeVideoId(url) {
        const regExp =
          /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return match && match[2].length === 11 ? match[2] : null;
      }

      // Load volume from localStorage
      function loadVolumeFromStorage() {
        const savedVolume = localStorage.getItem("videoVolume");
        if (savedVolume !== null) {
          const volume = parseFloat(savedVolume);
          if (player) {
            player.setVolume(volume * 100);
          }
          volumeFill.style.width = volume * 100 + "%";
          return volume;
        }
        return 1; // Default volume
      }

      // Save volume to localStorage
      function saveVolumeToStorage(volume) {
        localStorage.setItem("videoVolume", volume.toString());
      }

      // YouTube IFrame API Ready
      function onYouTubeIframeAPIReady() {
        const videoUrl = document
          .querySelector("[data-video-url]")
          ?.getAttribute("data-video-url");
        if (videoUrl) {
          currentVideoId = getYouTubeVideoId(videoUrl);
          initYouTubePlayer();
        }
      }

      // Initialize YouTube Player
      function initYouTubePlayer() {
        if (!currentVideoId) return;

        player = new YT.Player("youtubePlayer", {
          height: "100%",
          width: "100%",
          videoId: currentVideoId,
          playerVars: {
            autoplay: 0,
            controls: 0,
            disablekb: 1,
            fs: 0,
            rel: 0,
            showinfo: 0,
            modestbranding: 1,
            iv_load_policy: 3,
            cc_load_policy: 0,
          },
          events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
            onError: onPlayerError,
          },
        });
      }

      // Player Ready Event
      function onPlayerReady(event) {
        loadingSpinner.style.display = "none";
        durationDisplay.textContent = formatTime(player.getDuration());
        const savedVolume = loadVolumeFromStorage();
        player.setVolume(savedVolume * 100);
        volumeFill.style.width = savedVolume * 100 + "%";
        initControls();
        startProgressTracking();
      }

      // Player State Change Event
      function onPlayerStateChange(event) {
        switch (event.data) {
          case YT.PlayerState.PLAYING:
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            loadingSpinner.style.display = "none";
            break;
          case YT.PlayerState.PAUSED:
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            loadingSpinner.style.display = "none";
            break;
          case YT.PlayerState.ENDED:
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            loadingSpinner.style.display = "none";
            // T·ª± ƒë·ªông ƒë√°nh d·∫•u ho√†n th√†nh khi video k·∫øt th√∫c
            autoMarkAsCompleted();
            break;
          case YT.PlayerState.BUFFERING:
            loadingSpinner.style.display = "block";
            break;
          case YT.PlayerState.CUED:
            loadingSpinner.style.display = "none";
            break;
          case YT.PlayerState.UNSTARTED:
            loadingSpinner.style.display = "none";
            break;
        }
      }

      // Player Error Event
      function onPlayerError(event) {
        console.error("YouTube Player Error:", event.data);
        loadingSpinner.style.display = "none";
      }

      // Start progress tracking
      function startProgressTracking() {
        if (progressInterval) {
          clearInterval(progressInterval);
        }
        progressInterval = setInterval(updateProgress, 1000);
      }

      // Stop progress tracking
      function stopProgressTracking() {
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
      }

      // Initialize Controls
      function initControls() {
        playPauseBtn.addEventListener("click", togglePlayPause);
        rewindBtn.addEventListener("click", rewindVideo);
        forwardBtn.disabled = true;
        muteBtn.addEventListener("click", toggleMute);
        progressContainer.addEventListener("click", seekToPosition);
        volumeSlider.addEventListener("click", adjustVolume);
        document.addEventListener("keydown", handleKeyboard);
      }

      // Toggle play/pause
      function togglePlayPause() {
        if (player && player.getPlayerState) {
          const state = player.getPlayerState();
          if (state === YT.PlayerState.PLAYING) {
            player.pauseVideo();
          } else {
            player.playVideo();
          }
        }
      }

      // Rewind video
      function rewindVideo() {
        if (maxWatchedTime > 0 && player) {
          let targetTime = Math.max(0, maxWatchedTime - 10);
          player.seekTo(targetTime, true);
        }
      }

      // Toggle mute
      function toggleMute() {
        if (player) {
          if (player.isMuted()) {
            player.unMute();
            muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
          } else {
            player.mute();
            muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
          }
        }
      }

      // Update progress bar
      function updateProgress() {
        if (player && player.getCurrentTime && player.getDuration) {
          const currentTime = player.getCurrentTime();
          const duration = player.getDuration();

          if (duration > 0 && !isNaN(currentTime) && !isNaN(duration)) {
            let progress = (currentTime / duration) * 100;
            progressBar.style.width = progress + "%";
            progressHandle.style.left = progress + "%";
            currentTimeDisplay.textContent = formatTime(currentTime);
            updateWatchedSegments(currentTime);

            // Update video watch progress
            videoWatchProgress = progress;
            updateWatchProgressUI();

            // T·ª± ƒë·ªông ƒë√°nh d·∫•u ho√†n th√†nh khi xem ƒë∆∞·ª£c 100%
            if (progress >= 100 && !hasAutoMarked) {
              hasAutoMarked = true;
              autoMarkAsCompleted();
            }
          }
        }
      }

      // Update watched segments
      function updateWatchedSegments(currentTime) {
        if (currentTime > maxWatchedTime) {
          maxWatchedTime = currentTime;
        }
        let segmentFound = watchedSegments.find(
          (segment) => Math.abs(segment - currentTime) < 1
        );
        if (!segmentFound) {
          watchedSegments.push(currentTime);
        }
      }

      // Seek to position
      function seekToPosition(e) {
        if (!player) return;
        let rect = progressContainer.getBoundingClientRect();
        let clickX = e.clientX - rect.left;
        let percentage = clickX / rect.width;
        let seekTime = percentage * player.getDuration();
        // ch·ªâ cho ph√©p ng∆∞·ªùi d√πng t√¨m ki·∫øm trong kho·∫£ng th·ªùi gian ƒë√£ xem:
        /*if (seekTime <= maxWatchedTime) {
          player.seekTo(seekTime, true);
        }*/
        player.seekTo(seekTime, true);
      }

      // Adjust volume
      function adjustVolume(e) {
        if (!player) return;
        let rect = volumeSlider.getBoundingClientRect();
        let clickX = e.clientX - rect.left;
        let percentage = Math.max(0, Math.min(1, clickX / rect.width));
        player.setVolume(percentage * 100);
        volumeFill.style.width = percentage * 100 + "%";
        saveVolumeToStorage(percentage);
      }

      // Format time display
      function formatTime(seconds) {
        if (isNaN(seconds)) return "0:00";
        let minutes = Math.floor(seconds / 60);
        seconds = Math.floor(seconds % 60);
        return minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
      }

      // Handle keyboard shortcuts
      function handleKeyboard(e) {
        // N·∫øu ƒëang focus v√†o √¥ chat th√¨ b·ªè qua c√°c ph√≠m t·∫Øt video
        if (document.activeElement === aiChatInput) return;
        switch (e.code) {
          case "Space":
            e.preventDefault();
            togglePlayPause();
            break;
          case "ArrowLeft":
            e.preventDefault();
            rewindVideo();
            break;
          case "KeyM":
            e.preventDefault();
            toggleMute();
            break;
        }
      }

      // Load new video
      function loadVideo(videoUrl) {
        const videoId = getYouTubeVideoId(videoUrl);
        if (videoId && player && player.loadVideoById) {
          currentVideoId = videoId;
          maxWatchedTime = 0;
          watchedSegments = [];
          hasAutoMarked = false; // Reset auto-mark flag for new video
          player.loadVideoById(videoId);
          loadingSpinner.style.display = "block";
        }
      }

      // Toggle AI Chat visibility
      document
        .getElementById("toggleAiChat")
        .addEventListener("click", function () {
          toggleAiChat();
        });

      document
        .getElementById("collapseAiChat")
        .addEventListener("click", function () {
          toggleAiChat();
        });

      function toggleAiChat() {
        const mainContainer = document.getElementById("mainContainer");
        const aiChatSection = document.getElementById("aiChatSection");
        const toggleIcon = document.getElementById("toggleIcon");

        if (aiChatSection.style.display === "none") {
          aiChatSection.style.display = "flex";
          mainContainer.classList.add("ai-expanded");
          toggleIcon.classList.remove("fa-comment-alt");
          toggleIcon.classList.add("fa-chevron-right");
        } else {
          aiChatSection.style.display = "none";
          mainContainer.classList.remove("ai-expanded");
          toggleIcon.classList.remove("fa-chevron-right");
          toggleIcon.classList.add("fa-comment-alt");
        }
      }

      // --- AI Chatbot Integration ---
      const aiChatForm = document.getElementById("aiChatForm");
      const aiChatInput = document.getElementById("aiChatInput");
      const aiChatBody = document.getElementById("aiChatBody");
      const aiChatSendBtn = document.getElementById("aiChatSendBtn");
      let aiChatLoading = false;

      aiChatForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        if (aiChatLoading) return;
        const question = aiChatInput.value.trim();
        if (!question) return;
        addUserMessage(question);
        aiChatInput.value = "";
        aiChatSendBtn.disabled = true;
        aiChatLoading = true;
        addLoadingMessage();
        try {
          const response = await fetch("/api/chatbot/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question }),
          });
          const data = await response.json();
          removeLoadingMessage();
          if (data && data.success && data.data && data.data.answer) {
            addAiMessage(data.data.answer);
          } else {
            addAiMessage(
              data && data.message ? data.message : "ƒê√£ x·∫£y ra l·ªói."
            );
          }
        } catch (err) {
          removeLoadingMessage();
          addAiMessage("L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.");
        }
        aiChatSendBtn.disabled = false;
        aiChatLoading = false;
        aiChatBody.scrollTop = aiChatBody.scrollHeight;
      });

      function addUserMessage(text) {
        const msg = document.createElement("div");
        msg.className = "chat-message user";
        msg.innerHTML = `<div class="chat-bubble">${escapeHtml(
          text
        )}</div><div class="chat-avatar user"><i class="fas fa-user"></i></div>`;
        aiChatBody.appendChild(msg);
        aiChatBody.scrollTop = aiChatBody.scrollHeight;
      }
      function markdownToHtml(text) {
        // ƒê·∫≠m: **text**
        text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        // Nghi√™ng: *text*
        text = text.replace(/\*(.*?)\*/g, "<em>$1</em>");
        // Code: `text`
        text = text.replace(/`([^`]+)`/g, "<code>$1</code>");
        // Xu·ªëng d√≤ng
        text = text.replace(/\\n/g, "<br>");
        return text;
      }

      function addAiMessage(text) {
        const msg = document.createElement("div");
        msg.className = "chat-message";
        msg.innerHTML = `<div class="chat-avatar ai"><i class="fas fa-robot"></i></div><div class="chat-bubble">${markdownToHtml(
          escapeHtml(text)
        )}</div>`;
        aiChatBody.appendChild(msg);
        aiChatBody.scrollTop = aiChatBody.scrollHeight;
      }
      function addLoadingMessage() {
        const msg = document.createElement("div");
        msg.className = "chat-message";
        msg.id = "aiChatLoadingMsg";
        msg.innerHTML = `<div class="chat-avatar ai"><i class="fas fa-robot"></i></div><div class="chat-bubble"><span class='loading-spinner' style='position:static;width:24px;height:24px;border-width:3px;'></span></div>`;
        aiChatBody.appendChild(msg);
        aiChatBody.scrollTop = aiChatBody.scrollHeight;
      }
      function removeLoadingMessage() {
        const msg = document.getElementById("aiChatLoadingMsg");
        if (msg) msg.remove();
      }
      function escapeHtml(text) {
        return text.replace(/[&<>"]/g, function (c) {
          return { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c];
        });
      }

      // Check course completion status on page load
      function checkCourseCompletionStatus() {
        // Get progress info from Thymeleaf template variables
        const progressInfo = {
          progress: /*[[${progressInfo != null ? progressInfo.progress() : 0}]]*/ 0,
          isCompleted: /*[[${progressInfo != null ? progressInfo.isCompleted() : false}]]*/ false,
          totalVideos: /*[[${videos != null ? videos.size() : 0}]]*/ 0,
          completedVideos: /*[[${progressInfo != null ? progressInfo.completedVideos() : 0}]]*/ 0,
        };

        // Check if all videos are completed but course is not yet completed
        if (progressInfo.progress >= 100 && !progressInfo.isCompleted) {
          // Show notification after a short delay to ensure page is fully loaded
          setTimeout(() => {
            showNotification(
              "üéâ B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ video! H√£y l√†m b√†i ki·ªÉm tra ƒë·ªÉ nh·∫≠n ch·ª©ng ch·ªâ.",
              "success"
            );

            // Show quiz modal after a delay
            setTimeout(() => {
              showQuizModal();
            }, 3000);
          }, 1000);
        }
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Video URL is already set as data attribute in HTML

        // Initialize mark completed button
        initializeMarkCompletedButton();

        // Check course completion status
        checkCourseCompletionStatus();
      });

      // Handle mark completed button
      function initializeMarkCompletedButton() {
        const markCompletedBtn = document.getElementById("markCompletedBtn");
        if (markCompletedBtn) {
          markCompletedBtn.addEventListener("click", async function () {
            const courseId = this.getAttribute("data-course-id");
            const videoId = this.getAttribute("data-video-id");

            if (!courseId || !videoId) {
              alert("Th√¥ng tin kh√≥a h·ªçc ho·∫∑c video kh√¥ng h·ª£p l·ªá");
              return;
            }

            // Check if user has watched enough of the video
            if (videoWatchProgress < REQUIRED_WATCH_PERCENTAGE) {
              showNotification(
                `B·∫°n c·∫ßn xem √≠t nh·∫•t ${REQUIRED_WATCH_PERCENTAGE}% video ƒë·ªÉ ƒë√°nh d·∫•u ho√†n th√†nh`,
                "error"
              );
              return;
            }

            // Disable button to prevent multiple clicks
            this.disabled = true;
            this.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> <span>ƒêang x·ª≠ l√Ω...</span>';

            try {
              const response = await fetch(
                "/video-learning/api/mark-completed",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                  },
                  body: `courseId=${courseId}&videoId=${videoId}`,
                }
              );

              const data = await response.json();

              if (data.success) {
                // Update progress bar
                updateProgressDisplay(data.data);

                // Show success message
                showNotification("ƒê√£ ho√†n th√†nh video!", "success");

                // Update button state
                this.innerHTML =
                  '<i class="fas fa-check"></i> <span>ƒê√£ ho√†n th√†nh</span>';
                this.style.background = "#45a049";

                // Check if all videos are now complete
                if (data.data.progress >= 100 && !data.data.isCompleted) {
                  showNotification(
                    "üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ video! H√£y l√†m b√†i ki·ªÉm tra ƒë·ªÉ nh·∫≠n ch·ª©ng ch·ªâ.",
                    "success"
                  );

                  // Show quiz modal after a delay
                  setTimeout(() => {
                    showQuizModal();
                  }, 2000);
                } else if (data.data.isCompleted) {
                  showNotification(
                    "üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh kh√≥a h·ªçc!",
                    "success"
                  );
                }
                // Per user request, do not navigate to the next video automatically.
                // The video will continue to play.
              } else {
                showNotification(data.message || "C√≥ l·ªói x·∫£y ra", "error");
                // Re-enable button
                this.disabled = false;
                this.innerHTML =
                  '<i class="fas fa-check-circle"></i> <span>ƒê√£ ho√†n th√†nh</span>';
              }
            } catch (error) {
              console.error("Error marking video as completed:", error);
              showNotification(
                "C√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß",
                "error"
              );
              // Re-enable button
              this.disabled = false;
              this.innerHTML =
                '<i class="fas fa-check-circle"></i> <span>ƒê√£ ho√†n th√†nh</span>';
            }
          });
        }
      }

      // Update progress display
      function updateProgressDisplay(progressInfo) {
        const progressFill = document.querySelector(".course-progress-fill");
        const progressText = document.querySelector(".course-progress-text");

        if (progressFill && progressText) {
          const roundedProgress = Math.round(progressInfo.progress);
          progressFill.style.width = roundedProgress + "%";
          progressText.textContent = roundedProgress + "%";
        }

        // Update video list to show completed status
        updateVideoListUI(progressInfo);
      }

      // Update video list UI after completing a video
      function updateVideoListUI(progressInfo) {
        const videoItems = document.querySelectorAll(".lesson-item");
        const completedVideos = progressInfo.completedVideos;

        videoItems.forEach((item, index) => {
          const link = item.querySelector("a");
          const statusSpan = item.querySelector(".lesson-status");

          if (index < completedVideos) {
            // Video ƒë√£ ho√†n th√†nh
            item.classList.remove("locked");
            item.classList.add("completed");
            link.classList.remove("locked-link");
            link.href = `/video-learning/${courseId}/${videoIds[index]}`;

            // C·∫≠p nh·∫≠t icon
            if (statusSpan) {
              statusSpan.innerHTML =
                '<i class="fas fa-check-circle watched-icon" style="color: #4caf50"></i>';
            }
          } else if (index === completedVideos) {
            // Video hi·ªán t·∫°i (c√≥ th·ªÉ xem)
            item.classList.remove("locked");
            item.classList.remove("completed");
            link.classList.remove("locked-link");
            link.href = `/video-learning/${courseId}/${videoIds[index]}`;

            // C·∫≠p nh·∫≠t icon
            if (statusSpan) {
              statusSpan.innerHTML =
                '<i class="fas fa-play-circle" style="color: #002855"></i>';
            }
          } else {
            // Video b·ªã kh√≥a
            item.classList.add("locked");
            item.classList.remove("completed");
            link.classList.add("locked-link");
            link.href = "javascript:void(0)";

            // C·∫≠p nh·∫≠t icon
            if (statusSpan) {
              statusSpan.innerHTML =
                '<i class="fas fa-lock locked-icon" style="color: #ccc"></i>';
            }
          }
        });

        // C·∫≠p nh·∫≠t n√∫t "B√†i ti·∫øp theo" n·∫øu c√≥
        updateNextVideoButton(completedVideos);
      }

      // Update next video button
      function updateNextVideoButton(completedVideos) {
        const nextVideoBtn = document.querySelector(".control-right a");
        const nextVideoDisabledBtn = document.querySelector(
          ".control-right button[disabled]"
        );

        if (completedVideos < totalVideos - 1) {
          // C√≥ video ti·∫øp theo
          if (nextVideoBtn) {
            nextVideoBtn.style.display = "inline-flex";
          }
          if (nextVideoDisabledBtn) {
            nextVideoDisabledBtn.style.display = "none";
          }
        } else {
          // Kh√¥ng c√≥ video ti·∫øp theo
          if (nextVideoBtn) {
            nextVideoBtn.style.display = "none";
          }
          if (nextVideoDisabledBtn) {
            nextVideoDisabledBtn.style.display = "inline-flex";
          }
        }
      }

      // T·ª± ƒë·ªông ƒë√°nh d·∫•u ho√†n th√†nh khi video k·∫øt th√∫c
      async function autoMarkAsCompleted() {
        const markCompletedBtn = document.getElementById("markCompletedBtn");

        // Ch·ªâ t·ª± ƒë·ªông ƒë√°nh d·∫•u n·∫øu c√≥ n√∫t mark completed v√† user ch∆∞a ƒë√°nh d·∫•u
        if (
          markCompletedBtn &&
          !markCompletedBtn.disabled &&
          markCompletedBtn.style.display !== "none"
        ) {
          const courseId = markCompletedBtn.getAttribute("data-course-id");
          const videoId = markCompletedBtn.getAttribute("data-video-id");

          if (!courseId || !videoId) {
            console.error("Th√¥ng tin kh√≥a h·ªçc ho·∫∑c video kh√¥ng h·ª£p l·ªá");
            return;
          }

          try {
            const response = await fetch("/video-learning/api/mark-completed", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: `courseId=${courseId}&videoId=${videoId}`,
            });

            const data = await response.json();

            if (data.success) {
              // Update progress bar
              updateProgressDisplay(data.data);

              // Show success message
              showNotification(
                "Video ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông ƒë√°nh d·∫•u ho√†n th√†nh!",
                "success"
              );

              // Update button state
              markCompletedBtn.innerHTML =
                '<i class="fas fa-check"></i> <span>ƒê√£ ho√†n th√†nh</span>';
              markCompletedBtn.style.background = "#45a049";
              markCompletedBtn.disabled = true;

              // Check if all videos are completed (progress = 100%) but course not yet completed
              if (data.data.progress >= 100 && !data.data.isCompleted) {
                setTimeout(() => {
                  showNotification(
                    "üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ video! H√£y l√†m b√†i ki·ªÉm tra ƒë·ªÉ nh·∫≠n ch·ª©ng ch·ªâ.",
                    "success"
                  );

                  // Show quiz modal after a delay
                  setTimeout(() => {
                    showQuizModal();
                  }, 2000);
                }, 1000);
              } else if (data.data.isCompleted) {
                setTimeout(() => {
                  showNotification(
                    "üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh kh√≥a h·ªçc!",
                    "success"
                  );
                }, 1000);
              } else {
                // N·∫øu ch∆∞a ho√†n th√†nh t·∫•t c·∫£ video, chuy·ªÉn ƒë·∫øn video ti·∫øp theo
                const nextVideoIndex = data.data.completedVideos;
                if (nextVideoIndex < totalVideos) {
                  setTimeout(() => {
                    showNotification("Chuy·ªÉn ƒë·∫øn video ti·∫øp theo...", "info");
                    // Redirect to next video
                    setTimeout(() => {
                      window.location.href = `/video-learning/${courseId}/${videoIds[nextVideoIndex]}`;
                    }, 2000);
                  }, 1000);
                }
              }
            } else {
              console.error(
                "L·ªói khi t·ª± ƒë·ªông ƒë√°nh d·∫•u ho√†n th√†nh:",
                data.message
              );
            }
          } catch (error) {
            console.error("Error auto marking video as completed:", error);
          }
        }
      }

      // Show notification
      function showNotification(message, type = "info") {
        // Create notification element
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.innerHTML = `
          <i class="fas fa-${
            type === "success"
              ? "check-circle"
              : type === "error"
              ? "exclamation-circle"
              : "info-circle"
          }"></i>
          <span>${message}</span>
        `;

        // Add to page
        document.body.appendChild(notification);

        // Show notification
        setTimeout(() => {
          notification.classList.add("show");
        }, 100);

        // Remove notification after 3 seconds
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }

      // Update watch progress UI
      function updateWatchProgressUI() {
        const markCompletedBtn = document.getElementById("markCompletedBtn");
        const watchProgressText = document.getElementById("watchProgressText");
        const remainingPercent = document.getElementById("remainingPercent");

        if (videoWatchProgress >= REQUIRED_WATCH_PERCENTAGE) {
          // Show mark completed button
          if (markCompletedBtn) {
            markCompletedBtn.style.display = "inline-flex";
          }
          // Hide progress text
          if (watchProgressText) {
            watchProgressText.style.display = "none";
          }
        } else {
          // Hide mark completed button
          if (markCompletedBtn) {
            markCompletedBtn.style.display = "none";
          }
          // Show progress text
          if (watchProgressText && remainingPercent) {
            watchProgressText.style.display = "block";
            const remaining = Math.ceil(
              REQUIRED_WATCH_PERCENTAGE - videoWatchProgress
            );
            remainingPercent.textContent = remaining;
          }
        }
      }

      // Handle video click
      function handleVideoClick(element) {
        const isLocked = element.getAttribute("data-is-locked") === "true";
        if (isLocked) {
          showLockedMessage();
          return false;
        }
        return true;
      }

      // Handle quiz click
      function handleQuizClick(element) {
        const allVideosWatched =
          element.getAttribute("data-all-videos-watched") === "true";
        if (!allVideosWatched) {
          alert("B·∫°n c·∫ßn xem h·∫øt t·∫•t c·∫£ video tr∆∞·ªõc khi l√†m b√†i ki·ªÉm tra.");
          return false;
        }
        return true;
      }

      // Show locked message
      function showLockedMessage() {
        showNotification(
          "B·∫°n c·∫ßn ho√†n th√†nh video tr∆∞·ªõc ƒë√≥ tr∆∞·ªõc khi xem video n√†y",
          "error"
        );
      }

      // Quiz Modal Functions
      function showQuizModal() {
        const modal = document.getElementById("quizModal");
        modal.classList.add("show");
      }

      function closeQuizModal() {
        const modal = document.getElementById("quizModal");
        modal.classList.remove("show");
      }

      function goToQuiz() {
        window.location.href = `/video-learning/quiz/${courseId}`;
      }

      // Close modal when clicking outside
      document
        .getElementById("quizModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeQuizModal();
          }
        });

      // Cleanup on page unload
      window.addEventListener("beforeunload", function () {
        stopProgressTracking();
      });
    </script>

    <!-- Quiz Modal -->
    <div id="quizModal" class="quiz-modal">
      <div class="quiz-modal-content">
        <div class="quiz-modal-header">
          <i class="fas fa-trophy"></i>
          <h3>Ch√∫c m·ª´ng!</h3>
        </div>
        <div class="quiz-modal-body">
          <p>B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ video trong kh√≥a h·ªçc!</p>
          <p>H√£y l√†m b√†i ki·ªÉm tra ƒë·ªÉ nh·∫≠n ch·ª©ng ch·ªâ ho√†n th√†nh kh√≥a h·ªçc.</p>
        </div>
        <div class="quiz-modal-buttons">
          <button class="quiz-modal-btn secondary" onclick="closeQuizModal()">
            ƒê·ªÉ sau
          </button>
          <button class="quiz-modal-btn primary" onclick="goToQuiz()">
            L√†m b√†i ki·ªÉm tra
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
