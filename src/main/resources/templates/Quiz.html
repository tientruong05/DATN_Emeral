<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'B√†i ki·ªÉm tra: ' + ${course?.ten_khoa_hoc ?: 'Kh√≥a h·ªçc kh√¥ng x√°c ƒë·ªãnh'}">B√†i ki·ªÉm tra</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* CSS gi·ªØ nguy√™n t·ª´ m√£ g·ªëc */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            color: #333;
            line-height: 1.6;
            background-color: #f7f9fc;
        }
        .page-wrapper {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 1rem;
        }
        .exam-container {
            width: 100%;
        }
        .exam-header {
            background: linear-gradient(135deg, #002855 0%, #001f42 100%);
            color: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        .exam-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        .exam-info {
            position: relative;
            z-index: 1;
        }
        .exam-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .exam-title i {
            color: #ff6b00;
            font-size: 2.2rem;
        }
        .exam-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        .detail-item i {
            color: #ff6b00;
            font-size: 1.2rem;
            width: 20px;
            text-align: center;
        }
        .detail-text {
            display: flex;
            flex-direction: column;
        }
        .detail-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 0.25rem;
        }
        .detail-value {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .timer-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .timer-icon {
            font-size: 1.5rem;
            animation: tick 1s linear infinite;
        }
        @keyframes tick {
            0%, 50% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .timer-text {
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .question-nav {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .question-nav-title {
            color: #002855;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }
        .question-nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 0.75rem;
        }
        .question-nav-item {
            width: 50px;
            height: 50px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        .question-nav-item:hover {
            border-color: #002855;
            transform: scale(1.05);
        }
        .question-nav-item.current {
            background: linear-gradient(135deg, #002855 0%, #001f42 100%);
            color: white;
            border-color: #002855;
        }
        .question-nav-item.answered {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-color: #28a745;
        }
        .question-nav-item.flagged {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #333;
            border-color: #ffc107;
        }
        .nav-legend {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid;
        }
        .legend-color.current {
            background: linear-gradient(135deg, #002855 0%, #001f42 100%);
            border-color: #002855;
        }
        .legend-color.answered {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-color: #28a745;
        }
        .legend-color.unanswered {
            background: white;
            border-color: #e1e5e9;
        }
        .legend-color.flagged {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            border-color: #ffc107;
        }
        .question-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            opacity: 0;
            animation: slideInUp 0.6s ease forwards;
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .question-header {
            background: linear-gradient(135deg, #002855 0%, #001f42 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
        }
        .question-number {
            background: #ff6b00;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(255, 107, 0, 0.3);
        }
        .question-info {
            flex: 1;
        }
        .question-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .question-meta {
            font-size: 0.9rem;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .question-content {
            padding: 2rem;
        }
        .question-text {
            font-size: 1.15rem;
            color: #333;
            line-height: 1.7;
            margin-bottom: 2rem;
            font-weight: 500;
        }
        .answer-options {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .answer-option {
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafbfc;
            position: relative;
            overflow: hidden;
        }
        .answer-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 40, 85, 0.05), transparent);
            transition: left 0.6s ease;
        }
        .answer-option:hover::before {
            left: 100%;
        }
        .answer-option:hover {
            border-color: #002855;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 40, 85, 0.15);
        }
        .answer-option.selected {
            border-color: #002855;
            background: linear-gradient(135deg, #e8f2ff 0%, #f0f7ff 100%);
            box-shadow: 0 8px 25px rgba(0, 40, 85, 0.2);
        }
        .answer-option.selected::after {
            content: '‚úì';
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #002855;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .answer-content {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            position: relative;
            z-index: 1;
        }
        .option-letter {
            background: #002855;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        .answer-option.selected .option-letter {
            background: #ff6b00;
            transform: scale(1.1);
        }
        .option-text {
            flex: 1;
            font-size: 1rem;
            line-height: 1.6;
            color: #333;
            font-weight: 500;
        }
        .exam-navigation {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .nav-button {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1rem;
            text-decoration: none;
            min-width: 150px;
            justify-content: center;
        }
        .prev-btn {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }
        .prev-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
        }
        .prev-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .next-btn {
            background: linear-gradient(135deg, #002855 0%, #001f42 100%);
            color: white;
        }
        .next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 40, 85, 0.3);
        }
        .submit-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            font-size: 1.1rem;
            padding: 1.25rem 3rem;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        .submit-btn:hover {
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.4);
        }
        .flag-button {
            position: absolute;
            top: 1.5rem;
            right: 2rem;
            background: transparent;
            border: 2px solid #ffc107;
            color: #ffc107;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        .flag-button:hover {
            background: #ffc107;
            color: #333;
            transform: scale(1.05);
        }
        .flag-button.flagged {
            background: #ffc107;
            color: #333;
        }
        .error-message {
            color: #dc3545;
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 600;
            display: none;
            background: rgba(220, 53, 69, 0.1);
            padding: 1rem;
            border-radius: 8px;
        }
        .completed-message {
            text-align: center;
            color: #28a745;
            font-weight: 600;
            padding: 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        @media (max-width: 1024px) {
            .page-wrapper {
                padding: 0.5rem;
            }
            .exam-details {
                grid-template-columns: 1fr 1fr;
            }
            .timer-container {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 1rem;
                justify-content: center;
            }
        }
        @media (max-width: 768px) {
            .exam-title {
                font-size: 1.5rem;
            }
            .exam-details {
                grid-template-columns: 1fr;
            }
            .question-header {
                padding: 1rem 1.5rem;
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            .question-content {
                padding: 1.5rem;
            }
            .exam-navigation {
                flex-direction: column;
                gap: 1rem;
            }
            .nav-button {
                width: 100%;
            }
            .question-nav-grid {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            }
            .question-nav-item {
                width: 45px;
                height: 45px;
            }
            .nav-legend {
                gap: 1rem;
                font-size: 0.8rem;
            }
            .flag-button {
                top: 1rem;
                right: 1rem;
                width: 40px;
                height: 40px;
            }
        }
        @media (max-width: 576px) {
            .exam-header {
                padding: 1.5rem;
            }
            .question-number {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            .answer-option {
                padding: 1rem;
            }
            .option-letter {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }
        }
		
		/* CSS cho Result Modal - Th√™m v√†o ph·∫ßn <style> trong file HTML */

			/* Modal Overlay */
			.modal-backdrop {
			    background: rgba(0, 0, 0, 0.7);
			    backdrop-filter: blur(5px);
			}

			/* Modal Dialog */
			#resultModal .modal-dialog {
			    max-width: 500px;
			    margin: 5rem auto;
			    animation: modalSlideIn 0.5s ease-out;
			}

			@keyframes modalSlideIn {
			    from {
			        opacity: 0;
			        transform: translateY(-50px) scale(0.95);
			    }
			    to {
			        opacity: 1;
			        transform: translateY(0) scale(1);
			    }
			}

			/* Modal Content */
			#resultModal .modal-content {
			    border: none;
			    border-radius: 20px;
			    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
			    overflow: hidden;
			    background: white;
			}

			/* Modal Header */
			#resultModal .modal-header {
			    background: linear-gradient(135deg, #002855 0%, #001f42 100%);
			    color: white;
			    padding: 2rem 2rem 1.5rem;
			    border-bottom: none;
			    position: relative;
			}

			#resultModal .modal-header::before {
			    content: '';
			    position: absolute;
			    top: -50%;
			    right: -20%;
			    width: 200%;
			    height: 200%;
			    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
			    animation: float 6s ease-in-out infinite;
			}

			#resultModal .modal-title {
			    font-size: 1.5rem;
			    font-weight: 700;
			    display: flex;
			    align-items: center;
			    gap: 0.75rem;
			    position: relative;
			    z-index: 1;
			}

			#resultModal .modal-title::before {
			    content: 'üèÜ';
			    font-size: 1.8rem;
			}

			/* Close button v·ªõi d·∫•u X r√µ r√†ng */
			#resultModal .btn-close {
			    background: rgba(255, 255, 255, 0.2);
			    border-radius: 50%;
			    width: 40px;
			    height: 40px;
			    backdrop-filter: blur(10px);
			    border: 2px solid rgba(255, 255, 255, 0.3);
			    position: relative;
			    z-index: 1;
			    opacity: 1;
			}

			#resultModal .btn-close::before {
			    content: '‚úï';
			    color: #fff;
			    font-size: 18px;
			    font-weight: bold;
			    position: absolute;
			    top: 50%;
			    left: 50%;
			    transform: translate(-50%, -50%);
			}

			#resultModal .btn-close:hover {
			    background: rgba(255, 255, 255, 0.3);
			    transform: scale(1.1);
			}

			/* Modal Body - Layout c·∫£i thi·ªán */
			#resultModal .modal-body {
			    padding: 2.5rem 2rem;
			    text-align: center;
			    font-size: 1.1rem;
			    line-height: 1.6;
			    color: #333;
			    background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 50%, #f0f7ff 100%);
			    display: flex;
			    flex-direction: column;
			    align-items: center;
			    gap: 1.5rem;
			}

			/* Message text styling */
			#resultModal .modal-body .result-message {
			    margin: 0;
			    font-weight: 500;
			}

			/* Success case - message v·ªõi tick xanh */
			#resultModal .modal-body:has-text("Ch√∫c m·ª´ng") {
			    background: linear-gradient(135deg, #e8f5e8 0%, #ffffff 50%, #f0fff0 100%);
			}

			#resultModal .modal-body:has-text("Ch√∫c m·ª´ng") .result-message::before {
			    content: '‚úÖ ';
			    font-size: 1.2rem;
			    margin-right: 0.5rem;
			}

			/* Failed case - message v·ªõi X ƒë·ªè */
			#resultModal .modal-body:has-text("ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán") {
			    background: linear-gradient(135deg, #ffeee8 0%, #ffffff 50%, #fff5f0 100%);
			}

			#resultModal .modal-body:has-text("ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán") .result-message::before {
			    content: '‚ùå ';
			    font-size: 1.2rem;
			    margin-right: 0.5rem;
			}

			/* Timeout case - message v·ªõi clock */
			#resultModal .modal-body:has-text("H·∫øt th·ªùi gian") .result-message::before {
			    content: '‚è∞ ';
			    font-size: 1.2rem;
			    margin-right: 0.5rem;
			}

			/* Links styling - button style */
			#resultModal .modal-body a {
			    color: white !important;
			    text-decoration: none !important;
			    font-weight: 600;
			    padding: 0.875rem 2rem;
			    border-radius: 25px;
			    display: inline-flex;
			    align-items: center;
			    justify-content: center;
			    gap: 0.5rem;
			    min-width: 180px;
			    transition: all 0.3s ease;
			    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			    margin: 0;
			}

			#resultModal .modal-body a:hover {
			    transform: translateY(-2px);
			    text-decoration: none !important;
			    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
			}

			/* Link cho tr∆∞·ªùng h·ª£p ƒë·∫°t (xem ch·ª©ng ch·ªâ) */
			#resultModal .modal-body a[href*="/certificate/"] {
			    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
			}

			#resultModal .modal-body a[href*="/certificate/"]:before {
			    content: 'üèÜ';
			    font-size: 1.1rem;
			}

			/* Link cho tr∆∞·ªùng h·ª£p kh√¥ng ƒë·∫°t (quay l·∫°i video) */
			#resultModal .modal-body a[href*="/video-learning/"] {
			    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
			}

			#resultModal .modal-body a[href*="/video-learning/"]:before {
			    content: 'üìπ';
			    font-size: 1.1rem;
			}

			/* Link cho tr∆∞·ªùng h·ª£p l√†m l·∫°i (quiz) */
			#resultModal .modal-body a[href*="/quiz/"] {
			    background: linear-gradient(135deg, #ff6b00 0%, #e55a00 100%);
			}

			#resultModal .modal-body a[href*="/quiz/"]:before {
			    content: 'üîÑ';
			    font-size: 1.1rem;
			}

			/* Modal Footer */
			#resultModal .modal-footer {
			    border-top: 1px solid #e9ecef;
			    padding: 1.5rem 2rem 2rem;
			    background: #fafbfc;
			    justify-content: center;
			}

			/* OK Button */
			#resultModal #okButton {
			    background: linear-gradient(135deg, #002855 0%, #001f42 100%);
			    color: white;
			    border: none;
			    border-radius: 25px;
			    padding: 0.75rem 2rem;
			    font-weight: 600;
			    font-size: 1rem;
			    min-width: 120px;
			    transition: all 0.3s ease;
			    box-shadow: 0 4px 15px rgba(0, 40, 85, 0.2);
			}

			#resultModal #okButton:hover {
			    transform: translateY(-2px);
			    box-shadow: 0 8px 25px rgba(0, 40, 85, 0.3);
			}

			/* Responsive cho mobile */
			@media (max-width: 576px) {
			    #resultModal .modal-dialog {
			        margin: 2rem 1rem;
			        max-width: none;
			    }
			    
			    #resultModal .modal-header {
			        padding: 1.5rem 1.5rem 1rem;
			    }
			    
			    #resultModal .modal-body {
			        padding: 2rem 1.5rem;
			        font-size: 1rem;
			    }
			    
			    #resultModal .modal-body a {
			        padding: 0.75rem 1.5rem;
			        font-size: 0.95rem;
			        min-width: 160px;
			    }
			    
			    #resultModal .modal-footer {
			        padding: 1rem 1.5rem 1.5rem;
			    }
			    
			    #resultModal .modal-title {
			        font-size: 1.25rem;
			    }
			}
		
    </style>
</head>
<body>
<div class="page-wrapper">
	
    <div class="exam-container">
        <!-- Error Message -->
        <div id="errorMessage" class="error-message" th:if="${errorMessage}" th:text="${errorMessage}"></div>

        <!-- Completed Course Message -->
        <div id="completedMessage" class="completed-message" th:if="${hasCompletedCourse != null and hasCompletedCourse}">
            B·∫°n ƒë√£ ho√†n th√†nh kh√≥a h·ªçc n√†y v√† kh√¥ng th·ªÉ l√†m l·∫°i b√†i ki·ªÉm tra. 
            <a th:href="@{/video-learning/{courseId}(courseId=${course?.ID_khoa_hoc ?: 0})}">Quay l·∫°i xem video</a>
        </div>

        <!-- Timer -->
        <div class="timer-container" th:unless="${hasCompletedCourse != null and hasCompletedCourse}">
            <i class="fas fa-clock timer-icon"></i>
            <span class="timer-text" id="timer">00:00</span>
        </div>

        <!-- Exam Header -->
        <div class="exam-header" th:unless="${hasCompletedCourse != null and hasCompletedCourse}">
            <div class="exam-info">
                <h1 class="exam-title">
                    <i class="fas fa-file-alt"></i>
                    B√†i ki·ªÉm tra: <span th:text="${course?.ten_khoa_hoc ?: 'Kh√≥a h·ªçc kh√¥ng x√°c ƒë·ªãnh'}">Kh√≥a h·ªçc</span>
                </h1>
                <div class="exam-details">
                    <div class="detail-item">
                        <i class="fas fa-question-circle"></i>
                        <div class="detail-text">
                            <span class="detail-label">T·ªïng s·ªë c√¢u h·ªèi</span>
                            <span class="detail-value" th:text="${#lists.size(questions)} + ' c√¢u'">0 c√¢u</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-clock"></i>
                        <div class="detail-text">
                            <span class="detail-label">Th·ªùi gian l√†m b√†i</span>
                            <span class="detail-value" th:text="${#lists.isEmpty(questions) ? '0 ph√∫t' : (#lists.size(questions) * 1) + ' ph√∫t'}">0 ph√∫t</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-trophy"></i>
                        <div class="detail-text">
                            <span class="detail-label">ƒêi·ªÉm ƒë·∫°t ch·ª©ng ch·ªâ</span>
                            <span class="detail-value" th:text="'‚â• ' + (${course?.diem_dat ?: 70}) + ' %'">‚â• 70%</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-graduation-cap"></i>
                        <div class="detail-text">
                            <span class="detail-label">Lo·∫°i b√†i ki·ªÉm tra</span>
                            <span class="detail-value">Tr·∫Øc nghi·ªám</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Question Navigation -->
        <div class="question-nav" th:if="${not #lists.isEmpty(questions) and (hasCompletedCourse == null or not hasCompletedCourse)}">
            <div class="question-nav-title">
                <i class="fas fa-th-large"></i>
                Danh s√°ch c√¢u h·ªèi
            </div>
            <div class="question-nav-grid" id="question-nav-grid">
                <div th:each="question, iterStat : ${questions}" 
                     class="question-nav-item" 
                     th:text="${iterStat.count}"
                     th:attr="onclick='goToQuestion(' + ${iterStat.index} + ')'"></div>
            </div>
            <div class="nav-legend">
                <div class="legend-item">
                    <div class="legend-color current"></div>
                    <span>C√¢u hi·ªán t·∫°i</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color answered"></div>
                    <span>ƒê√£ tr·∫£ l·ªùi</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color unanswered"></div>
                    <span>Ch∆∞a tr·∫£ l·ªùi</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color flagged"></div>
                    <span>ƒê√°nh d·∫•u</span>
                </div>
            </div>
        </div>

        <!-- Question Card -->
        <div class="question-card" th:if="${not #lists.isEmpty(questions) and (hasCompletedCourse == null or not hasCompletedCourse)}">
            <div class="question-header">
                <div class="question-number" id="question-number">1</div>
                <div class="question-info">
                    <div class="question-title" id="question-title">C√¢u h·ªèi 1</div>
                    <div class="question-meta" id="question-meta">
                        
                        <span><i class="fas fa-tag"></i> <span th:text="${course?.ten_khoa_hoc ?: 'Kh√≥a h·ªçc'}">Kh√≥a h·ªçc</span></span>
                    </div>
                </div>
                <button class="flag-button" id="flag-button" onclick="toggleFlag()" title="ƒê√°nh d·∫•u c√¢u h·ªèi">
                    <i class="fas fa-flag"></i>
                </button>
            </div>
            <div class="question-content">
                <div class="question-text" id="question-text"></div>
                <div class="answer-options" id="answer-options"></div>
            </div>
        </div>

        <!-- No Questions Message -->
        <div class="no-questions" th:if="${#lists.isEmpty(questions) and (hasCompletedCourse == null or not hasCompletedCourse)}">
            Kh√¥ng c√≥ c√¢u h·ªèi n√†o cho kh√≥a h·ªçc n√†y.
        </div>

        <!-- Navigation Buttons -->
        <div class="exam-navigation" th:if="${not #lists.isEmpty(questions) and (hasCompletedCourse == null or not hasCompletedCourse)}">
            <button id="prev-btn" class="nav-button prev-btn" disabled>
                <i class="fas fa-arrow-left"></i>
                C√¢u tr∆∞·ªõc
            </button>
            <button id="next-btn" class="nav-button next-btn">
                C√¢u sau
                <i class="fas fa-arrow-right"></i>
            </button>
            <button id="submit-btn" class="nav-button submit-btn" style="display: none;">
                <i class="fas fa-paper-plane"></i>
                N·ªôp b√†i
            </button>
		
        </div>

        <!-- Result Modal -->
        <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="resultModalLabel">K·∫øt qu·∫£ b√†i ki·ªÉm tra</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="resultMessage">
                        <!-- Message will be set dynamically -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="okButton">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS and Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const passScore10 = /*[[${course.diem_dat}]]*/ 7.0;
        const courseId = /*[[${course?.ID_khoa_hoc ?: 0}]]*/ 0;
        const userId = /*[[${user?.idNguoiDung ?: 0}]]*/ 0;
        const hasCompletedCourse = /*[[${hasCompletedCourse ?: false}]]*/ false;
        let totalQuestions = /*[[${#lists.size(questions)}]]*/ 0;
        let timeLimit = /*[[${totalTimeInSeconds ?: 0}]]*/ 0;
        let timeLeft = timeLimit;
        let currentQuestionIndex = 0;
        let answers = {};
        let flaggedQuestions = new Set();
        let questions = /*[[${questions}]]*/ [];
        let timerInterval;

        // Ki·ªÉm tra n·∫øu ng∆∞·ªùi d√πng ƒë√£ ho√†n th√†nh kh√≥a h·ªçc
        if (hasCompletedCourse) {
            document.querySelector('.timer-container').style.display = 'none';
            document.querySelector('.exam-header').style.display = 'none';
            document.querySelector('.question-nav').style.display = 'none';
            document.querySelector('.question-card').style.display = 'none';
            document.querySelector('.exam-navigation').style.display = 'none';
            document.querySelector('.no-questions').style.display = 'none';
            const modal = new bootstrap.Modal(document.getElementById('completedModal'));
            modal.show();
            return;
        }

        // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ c√¢u h·ªèi ho·∫∑c courseId kh√¥ng h·ª£p l·ªá
        if (totalQuestions === 0 || courseId === 0) {
            document.querySelector('.question-card').style.display = 'none';
            document.querySelector('.exam-navigation').style.display = 'none';
            document.querySelector('.question-nav').style.display = 'none';
            document.querySelector('.no-questions').style.display = 'block';
            document.querySelector('.timer-container').style.display = 'none';
            document.querySelector('#errorMessage').style.display = 'block';
            return;
        }

        // ƒê·ªìng b·ªô th·ªùi gian l√†m b√†i v·ªõi s·ªë c√¢u h·ªèi
        if (totalQuestions > 0) {
            if (timeLimit <= 0 || isNaN(timeLimit) || timeLimit !== totalQuestions * 60) {
                console.warn(`timeLimit kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng ƒë·ªìng b·ªô (${timeLimit} gi√¢y). S·ª≠ d·ª•ng gi√° tr·ªã d·ª±a tr√™n s·ªë c√¢u h·ªèi: ${totalQuestions} c√¢u * 60 gi√¢y = ${totalQuestions * 60} gi√¢y`);
                timeLimit = totalQuestions * 60; // 1 ph√∫t m·ªói c√¢u h·ªèi
                timeLeft = timeLimit;
            } else {
                console.log(`timeLimit ƒë∆∞·ª£c thi·∫øt l·∫≠p ƒë√∫ng: ${timeLimit} gi√¢y cho ${totalQuestions} c√¢u h·ªèi`);
            }
        } else {
            console.error("Kh√¥ng c√≥ c√¢u h·ªèi, kh√¥ng kh·ªüi ƒë·ªông timer");
        }

        function generateQuestionNavigation() {
            const navGrid = document.getElementById('question-nav-grid');
            navGrid.innerHTML = '';
            questions.forEach((_, index) => {
                const navItem = document.createElement('div');
                navItem.className = 'question-nav-item';
                navItem.textContent = index + 1;
                navItem.addEventListener('click', () => goToQuestion(index));
                navGrid.appendChild(navItem);
            });
            updateQuestionNavigation();
        }

        function updateQuestionNavigation() {
            const navItems = document.querySelectorAll('.question-nav-item');
            navItems.forEach((item, index) => {
                item.className = 'question-nav-item';
                if (index === currentQuestionIndex) item.classList.add('current');
                if (answers[index]) item.classList.add('answered');
                if (flaggedQuestions.has(index)) item.classList.add('flagged');
            });
        }

        function displayQuestion(index) {
            currentQuestionIndex = index;
            updateQuestionNavigation();
            const question = questions[index];
            if (!question) return;

            document.getElementById('question-number').textContent = index + 1;
            document.getElementById('question-title').textContent = `C√¢u h·ªèi ${index + 1}`;
            document.getElementById('question-text').textContent = question.noi_dung_cau_hoi || 'Kh√¥ng c√≥ n·ªôi dung c√¢u h·ªèi';
            document.getElementById('question-meta').innerHTML = `
                <span><i class="fas fa-star"></i> M·ª©c ƒë·ªô: C∆° b·∫£n</span>
                <span><i class="fas fa-tag"></i> ${question.course?.ten_khoa_hoc || 'Kh√≥a h·ªçc'}</span>
            `;

            const optionsContainer = document.getElementById('answer-options');
            optionsContainer.innerHTML = '';
            const options = [
                { letter: 'A', text: question.dap_an_a },
                { letter: 'B', text: question.dap_an_b },
                { letter: 'C', text: question.dap_an_c },
                { letter: 'D', text: question.dap_an_d }
            ].filter(option => option.text && option.text.trim() !== '');
            options.forEach((option) => {
                const optionElement = document.createElement('div');
                optionElement.className = `answer-option ${answers[index] === option.letter ? 'selected' : ''}`;
                optionElement.innerHTML = `
                    <div class="answer-content">
                        <div class="option-letter">${option.letter}</div>
                        <div class="option-text">${option.text}</div>
                    </div>
                `;
                optionElement.addEventListener('click', () => selectAnswer(index, option.letter));
                optionsContainer.appendChild(optionElement);
            });

            updateNavigationButtons();
            updateFlagButton();
        }

        function selectAnswer(questionIndex, answer) {
            answers[questionIndex] = answer;
            displayQuestion(currentQuestionIndex);
            updateQuestionNavigation();
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');
            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.style.display = currentQuestionIndex === totalQuestions - 1 ? 'none' : 'flex';
            submitBtn.style.display = currentQuestionIndex === totalQuestions - 1 ? 'flex' : 'none';
        }

        function goToQuestion(index) {
            if (index >= 0 && index < totalQuestions) {
                currentQuestionIndex = index;
                displayQuestion(currentQuestionIndex);
            }
        }

        function toggleFlag() {
            if (flaggedQuestions.has(currentQuestionIndex)) {
                flaggedQuestions.delete(currentQuestionIndex);
            } else {
                flaggedQuestions.add(currentQuestionIndex);
            }
            updateFlagButton();
            updateQuestionNavigation();
        }

        function updateFlagButton() {
            const flagButton = document.getElementById('flag-button');
            flagButton.classList.toggle('flagged', flaggedQuestions.has(currentQuestionIndex));
        }

        function startTimer(seconds) {
            if (seconds <= 0 || isNaN(seconds)) {
                console.error(`Th·ªùi gian l√†m b√†i kh√¥ng h·ª£p l·ªá: ${seconds} gi√¢y`);
                showError("Th·ªùi gian l√†m b√†i kh√¥ng h·ª£p l·ªá. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n.");
                return;
            }
            timeLeft = seconds;
            console.log(`B·∫Øt ƒë·∫ßu timer v·ªõi ${seconds} gi√¢y (${Math.floor(seconds / 60)} ph√∫t)`);
            timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    console.log("H·∫øt th·ªùi gian, t·ª± ƒë·ªông n·ªôp b√†i");
                    clearInterval(timerInterval);
                    submitQuiz();
                    return;
                }
                const minutes = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                document.getElementById('timer').textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                if (timeLeft <= 30) {
                    document.querySelector('.timer-container').style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                } else if (timeLeft <= 60) {
                    document.querySelector('.timer-container').style.background = 'linear-gradient(135deg, #ffc107 0%, #e0a800 100%)';
                }
                timeLeft--;
            }, 1000);
        }

		// THAY TH·∫æ function showResult trong JavaScript v·ªõi code n√†y:

		function showResult(message, redirectUrl = null) {
		    clearInterval(timerInterval);

		    const modalElement = document.getElementById('resultModal');
		    const resultMessage = document.getElementById('resultMessage');
		    const oldOkButton = document.getElementById('okButton');

		    // Clone ƒë·ªÉ g·ª° b·ªè s·ª± ki·ªán c≈©
		    const newOkButton = oldOkButton.cloneNode(true);
		    oldOkButton.parentNode.replaceChild(newOkButton, oldOkButton);

		    // T·∫°o HTML v·ªõi c·∫•u tr√∫c m·ªõi
		    resultMessage.innerHTML = `
		        <div class="result-message">${message}</div>
		    `;

		    newOkButton.addEventListener('click', function () {
		        const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
		        modalInstance.hide();
		        if (redirectUrl) {
		            window.location.href = redirectUrl;
		        } else {
		            window.location.href = `/quiz/${courseId}`;
		        }
		    });

		    const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
		    modal.show();
		}

        function showError(message) {
            clearInterval(timerInterval);
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            } else {
                console.error("Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ th√¥ng b√°o l·ªói, message:", message);
                showResult("L·ªói h·ªá th·ªëng: " + message + ". Vui l√≤ng ki·ªÉm tra log server.", `/video-learning/${courseId}`);
            }
        }

		function submitQuiz() {
		    console.log("B·∫Øt ƒë·∫ßu n·ªôp b√†i t·∫°i", new Date().toLocaleString(), { courseId: courseId, answers: answers, timeLeft: timeLeft });
		    clearInterval(timerInterval);

		    if (!courseId || courseId <= 0) {
		        console.error("Course ID kh√¥ng h·ª£p l·ªá:", courseId);
		        showError("M√£ kh√≥a h·ªçc kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.");
		        return;
		    }

		    const payload = { courseId: courseId, answers: answers, timeLeft: timeLeft || 0 };
		    console.log("G·ª≠i ƒë·∫øn server v·ªõi courseId:", courseId, "v√† payload:", JSON.stringify(payload));

		    fetch('/submit-quiz', {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json',
		            'Accept': 'application/json'
		        },
		        body: JSON.stringify(payload)
		    })
		    .then(response => {
		        if (!response.ok) {
		            console.error("L·ªói HTTP:", response.status, response.statusText);
		            return response.json().then(err => { throw new Error(err.message || `HTTP error! status: ${response.status}`); });
		        }
		        return response.json();
		    })
		    .then(data => {
		        const percentage = data.score; // V√≠ d·ª• 50%
		        const score10 = (percentage / 100 * 10).toFixed(1); // 5.0
		        const score10Float = parseFloat(score10); // ‚úÖ √âp v·ªÅ s·ªë ƒë·ªÉ so s√°nh

		        // Ki·ªÉm tra th√¥ng b√°o "H·∫øt th·ªùi gian, vui l√≤ng l√†m l·∫°i"
				if (data.message === "H·∫øt th·ªùi gian, vui l√≤ng l√†m l·∫°i.") {
				    showResult(`
				        H·∫øt th·ªùi gian l√†m b√†i!<br>
				        <a href="/quiz/${courseId}">L√†m l·∫°i b√†i ki·ªÉm tra</a>
				    `, `/quiz/${courseId}`);
				} else if (score10Float >= passScore10) {
				    showResult(`
				        Ch√∫c m·ª´ng! B·∫°n ƒë√£ ƒë·∫°t ${score10} ƒëi·ªÉm.<br>
				        <a href="/certificate/${courseId}/${userId}">Xem ch·ª©ng ch·ªâ</a>
				    `, `/certificate/${courseId}/${userId}`);
				} else {
				    showResult(`
				        B·∫°n ƒë·∫°t ${score10} ƒëi·ªÉm. Ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán nh·∫≠n ch·ª©ng ch·ªâ.<br>
				        <a href="/video-learning/${courseId}">Quay l·∫°i trang video</a>
				    `, `/quiz/${courseId}`);
				}
		    })
		    .catch(error => {
		        console.error("L·ªói n·ªôp b√†i:", error);
		        showError("C√≥ l·ªói khi n·ªôp b√†i: " + (error.message || "Kh√¥ng x√°c ƒë·ªãnh"));
		    });
		}
        document.getElementById('prev-btn')?.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion(currentQuestionIndex);
            }
        });

        document.getElementById('next-btn')?.addEventListener('click', () => {
            if (currentQuestionIndex < totalQuestions - 1) {
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
            }
        });

        document.getElementById('submit-btn')?.addEventListener('click', submitQuiz);

        document.getElementById('flag-button')?.addEventListener('click', toggleFlag);

        document.addEventListener('keydown', (e) => {
            if (hasCompletedCourse) return;
            if (e.key === 'ArrowLeft' && currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion(currentQuestionIndex);
            } else if (e.key === 'ArrowRight' && currentQuestionIndex < totalQuestions - 1) {
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
            } else if (e.key === 'f' || e.key === 'F') {
                toggleFlag();
            } else if (['1', '2', '3', '4'].includes(e.key)) {
                const optionIndex = parseInt(e.key) - 1;
                const optionLetter = String.fromCharCode(65 + optionIndex);
                if (questions[currentQuestionIndex][`dap_an_${optionLetter.toLowerCase()}`]) {
                    selectAnswer(currentQuestionIndex, optionLetter);
                }
            }
        });

        // Kh·ªüi t·∫°o giao di·ªán
        if (!hasCompletedCourse && totalQuestions > 0) {
            generateQuestionNavigation();
            displayQuestion(currentQuestionIndex);
            startTimer(timeLimit);
        }
    });
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9584f4fb8d1826d1',t:'MTc1MTM2Mjk4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
